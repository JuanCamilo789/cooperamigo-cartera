<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cooperamig√≥ ‚Äî Gesti√≥n de Cartera</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Familjen+Grotesk:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #05080f;
  --s1:       #0c1220;
  --s2:       #111d30;
  --s3:       #172540;
  --border:   #1e3250;
  --accent:   #3b82f6;
  --accent2:  #06b6d4;
  --green:    #22c55e;
  --yellow:   #eab308;
  --orange:   #f97316;
  --red:      #ef4444;
  --red2:     #dc2626;
  --text:     #e2e8f0;
  --text2:    #94a3b8;
  --text3:    #475569;
  --mono:     'DM Mono', monospace;
  --sans:     'Familjen Grotesk', sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;}

/* BG texture */
body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 20% 0%, rgba(59,130,246,0.06) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 100%, rgba(6,182,212,0.04) 0%, transparent 60%);pointer-events:none;z-index:0;}

/* LOGIN */
#loginScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000;background:var(--bg);}
.login-box{background:var(--s1);border:1px solid var(--border);border-radius:20px;padding:48px 40px;width:380px;text-align:center;}
.login-logo{font-size:13px;font-family:var(--mono);color:var(--accent2);letter-spacing:3px;margin-bottom:8px;}
.login-title{font-size:28px;font-weight:800;letter-spacing:-1px;margin-bottom:4px;}
.login-sub{font-size:13px;color:var(--text3);margin-bottom:32px;}
.login-input{width:100%;background:var(--s2);border:1px solid var(--border);color:var(--text);padding:12px 16px;border-radius:10px;font-family:var(--sans);font-size:14px;outline:none;margin-bottom:12px;transition:border-color .2s;}
.login-input:focus{border-color:var(--accent);}
.login-btn{width:100%;background:var(--accent);color:#fff;border:none;padding:13px;border-radius:10px;font-family:var(--sans);font-weight:700;font-size:15px;cursor:pointer;transition:all .2s;margin-top:4px;}
.login-btn:hover{background:#2563eb;transform:translateY(-1px);}
.login-error{color:var(--red);font-size:12px;font-family:var(--mono);margin-top:8px;display:none;}

/* APP LAYOUT */
#app{display:none;position:relative;z-index:1;}
.sidebar{position:fixed;left:0;top:0;bottom:0;width:230px;background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;}
.logo-wrap{padding:24px 20px 20px;border-bottom:1px solid var(--border);}
.logo-badge{font-family:var(--mono);font-size:10px;color:var(--accent2);letter-spacing:3px;margin-bottom:6px;}
.logo-name{font-size:20px;font-weight:800;letter-spacing:-0.5px;}
.logo-name span{color:var(--accent);}
.nav{padding:16px 12px;flex:1;overflow-y:auto;}
.nav-section{font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:2px;padding:12px 8px 6px;text-transform:uppercase;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;cursor:pointer;color:var(--text2);font-size:13px;font-weight:600;transition:all .15s;margin-bottom:2px;position:relative;}
.nav-item:hover{background:var(--s2);color:var(--text);}
.nav-item.active{background:rgba(59,130,246,0.12);color:var(--accent);border:1px solid rgba(59,130,246,0.2);}
.nav-badge{margin-left:auto;background:var(--red);color:#fff;border-radius:10px;padding:1px 7px;font-size:10px;font-family:var(--mono);}
.sidebar-footer{padding:16px;border-top:1px solid var(--border);}
.user-chip{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--s2);border-radius:10px;}
.user-avatar{width:30px;height:30px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}
.user-info{flex:1;min-width:0;}
.user-email{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.logout-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:2px;}
.logout-btn:hover{color:var(--red);}

/* MAIN */
.main{margin-left:230px;padding:28px;min-height:100vh;}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;}
.page-title{font-size:24px;font-weight:800;letter-spacing:-0.5px;}
.page-title span{color:var(--accent);}
.topbar-right{display:flex;align-items:center;gap:10px;}
.live-badge{display:flex;align-items:center;gap:6px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);padding:6px 12px;border-radius:20px;font-family:var(--mono);font-size:11px;color:var(--green);}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 1.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

.btn{padding:9px 18px;border-radius:8px;border:none;cursor:pointer;font-family:var(--sans);font-weight:700;font-size:13px;transition:all .2s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#2563eb;transform:translateY(-1px);}
.btn-outline{background:transparent;color:var(--text2);border:1px solid var(--border);}
.btn-outline:hover{border-color:var(--accent);color:var(--accent);}
.btn-sm{padding:5px 12px;font-size:12px;}
.btn-danger{background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.3);}

/* SECTIONS */
.section{display:none;}
.section.active{display:block;animation:fadeUp .3s ease both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* UPLOAD */
.upload-zone{border:2px dashed var(--border);border-radius:14px;padding:36px;text-align:center;cursor:pointer;transition:all .3s;background:var(--s1);margin-bottom:24px;}
.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:rgba(59,130,246,.05);}
.upload-zone.loaded{border-color:var(--green);background:rgba(34,197,94,.04);}
.upload-icon{font-size:40px;margin-bottom:10px;}
.upload-text{color:var(--text2);font-size:14px;line-height:1.6;}
.upload-text strong{color:var(--accent);}
.upload-hint{font-family:var(--mono);font-size:11px;color:var(--text3);margin-top:8px;}
.corte-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3);border-radius:20px;padding:4px 12px;font-family:var(--mono);font-size:11px;color:var(--green);margin-top:10px;}

/* KPI GRID */
.kpi-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:22px;}
.kpi{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:18px;position:relative;overflow:hidden;transition:transform .2s;}
.kpi:hover{transform:translateY(-2px);}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.kpi.bl::before{background:var(--accent);}
.kpi.re::before{background:var(--red);}
.kpi.ye::before{background:var(--yellow);}
.kpi.gr::before{background:var(--green);}
.kpi.cy::before{background:var(--accent2);}
.kpi-label{font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;}
.kpi-val{font-size:26px;font-weight:800;letter-spacing:-1px;line-height:1;}
.kpi-val.bl{color:var(--accent);}
.kpi-val.re{color:var(--red);}
.kpi-val.ye{color:var(--yellow);}
.kpi-val.gr{color:var(--green);}
.kpi-val.cy{color:var(--accent2);}
.kpi-sub{font-size:11px;color:var(--text3);margin-top:5px;font-family:var(--mono);}

/* CHARTS ROW */
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:22px;}
.card{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:20px;}
.card-title{font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:16px;}

/* BAR CHART */
.bar-rows{display:flex;flex-direction:column;gap:10px;}
.bar-row{display:flex;align-items:center;gap:10px;}
.bar-label{font-family:var(--mono);font-size:11px;color:var(--text2);width:40px;text-align:right;flex-shrink:0;}
.bar-track{flex:1;background:var(--s2);border-radius:4px;height:12px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;transition:width 1.2s cubic-bezier(.22,1,.36,1);}
.bar-info{font-family:var(--mono);font-size:11px;color:var(--text2);width:90px;text-align:right;flex-shrink:0;}

/* PIE */
.pie-wrap{display:flex;align-items:center;gap:20px;}
.pie-legend{display:flex;flex-direction:column;gap:8px;}
.pie-leg{display:flex;align-items:center;gap:8px;font-size:12px;font-family:var(--mono);}
.pie-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}

/* TABLE */
.table-wrap{background:var(--s1);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.table-controls{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.t-search{background:var(--s2);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:8px;font-family:var(--sans);font-size:13px;width:200px;outline:none;transition:border-color .2s;}
.t-search:focus{border-color:var(--accent);}
.t-select{background:var(--s2);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;font-family:var(--sans);font-size:13px;outline:none;cursor:pointer;}
.t-count{margin-left:auto;font-family:var(--mono);font-size:11px;color:var(--text3);}
table{width:100%;border-collapse:collapse;}
th{padding:10px 14px;text-align:left;font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;background:var(--s2);border-bottom:1px solid var(--border);cursor:pointer;user-select:none;white-space:nowrap;}
th:hover{color:var(--accent);}
td{padding:11px 14px;font-size:13px;border-bottom:1px solid rgba(30,50,80,.5);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(59,130,246,.03);}
.td-mono{font-family:var(--mono);font-size:12px;}
.td-right{text-align:right;}

/* BADGES */
.cat-badge{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:6px;font-size:12px;font-weight:700;font-family:var(--mono);}
.cat-A{background:rgba(34,197,94,.15);color:var(--green);}
.cat-B{background:rgba(234,179,8,.15);color:var(--yellow);}
.cat-C{background:rgba(249,115,22,.15);color:var(--orange);}
.cat-D{background:rgba(239,68,68,.15);color:var(--red);}
.cat-E{background:rgba(220,38,38,.3);color:#fca5a5;}

.mora-badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-family:var(--mono);font-size:11px;}
.mora-0{background:rgba(34,197,94,.12);color:var(--green);}
.mora-b{background:rgba(234,179,8,.12);color:var(--yellow);}
.mora-c{background:rgba(249,115,22,.12);color:var(--orange);}
.mora-d{background:rgba(239,68,68,.12);color:var(--red);}
.mora-e{background:rgba(220,38,38,.25);color:#fca5a5;}

.formapago-badge{font-family:var(--mono);font-size:11px;padding:3px 8px;border-radius:6px;}
.fp-T{background:rgba(59,130,246,.12);color:var(--accent);}
.fp-N{background:rgba(6,182,212,.12);color:var(--accent2);}

/* PAGINATION */
.pagination{display:flex;align-items:center;justify-content:flex-end;gap:6px;padding:12px 14px;border-top:1px solid var(--border);}
.pg-btn{width:30px;height:30px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;font-family:var(--mono);font-size:12px;transition:all .15s;display:flex;align-items:center;justify-content:center;}
.pg-btn:hover{border-color:var(--accent);color:var(--accent);}
.pg-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.pg-btn:disabled{opacity:.3;cursor:not-allowed;}
.pg-info{font-family:var(--mono);font-size:11px;color:var(--text3);margin-right:8px;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:500;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--s1);border:1px solid var(--border);border-radius:16px;width:560px;max-height:88vh;overflow-y:auto;padding:28px;transform:translateY(16px);transition:transform .2s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-title{font-size:18px;font-weight:800;letter-spacing:-.3px;margin-bottom:2px;}
.modal-sub{font-size:12px;color:var(--text3);font-family:var(--mono);margin-bottom:20px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-group{display:flex;flex-direction:column;gap:5px;margin-bottom:12px;}
.form-label{font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;}
.form-input,.form-select,.form-textarea{background:var(--s2);border:1px solid var(--border);color:var(--text);padding:10px 13px;border-radius:8px;font-family:var(--sans);font-size:13px;outline:none;transition:border-color .2s;width:100%;}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent);}
.form-textarea{resize:vertical;min-height:72px;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}

/* HISTORIAL */
.hist-list{margin-top:14px;}
.hist-title{font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:1px;margin-bottom:8px;}
.hist-item{background:var(--s2);border-radius:8px;padding:10px 12px;margin-bottom:6px;border-left:3px solid var(--accent);}
.hist-date{font-family:var(--mono);font-size:10px;color:var(--text3);}
.hist-text{font-size:12px;margin-top:3px;}
.hist-res{font-family:var(--mono);font-size:11px;color:var(--orange);margin-top:2px;}

/* ALERTS */
.alert-list{display:flex;flex-direction:column;gap:8px;}
.alert-item{display:flex;align-items:center;gap:14px;background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:14px 16px;border-left:3px solid transparent;animation:fadeUp .3s ease both;}
.alert-item.crit{border-left-color:var(--red);}
.alert-item.warn{border-left-color:var(--yellow);}
.alert-item.info{border-left-color:var(--accent);}
.alert-body{flex:1;}
.alert-name{font-weight:700;font-size:13px;}
.alert-detail{font-size:12px;color:var(--text2);font-family:var(--mono);margin-top:2px;}

/* RODAMIENTO */
.rod-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.rod-card{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;}
.rod-arrow{font-size:22px;margin-bottom:6px;}
.rod-label{font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:1px;margin-bottom:6px;}
.rod-count{font-size:28px;font-weight:800;}
.rod-saldo{font-family:var(--mono);font-size:10px;color:var(--text3);margin-top:4px;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:14px 18px;font-size:13px;z-index:999;transform:translateY(80px);opacity:0;transition:all .3s;max-width:300px;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{border-left:3px solid var(--green);}
.toast.err{border-left:3px solid var(--red);}

/* EMPTY */
.empty{text-align:center;padding:60px 20px;color:var(--text3);}
.empty-icon{font-size:44px;opacity:.25;margin-bottom:12px;}

/* LOADING */
.loading{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* REPORT CARDS */
.report-card{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:18px 20px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.report-info h3{font-size:14px;font-weight:700;}
.report-info p{font-size:12px;color:var(--text3);margin-top:3px;font-family:var(--mono);}

/* COBROS HOY */
.cobro-card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:14px;}
.cobro-icon{font-size:22px;flex-shrink:0;}
.cobro-body{flex:1;}
.cobro-nombre{font-weight:700;font-size:14px;}
.cobro-detail{font-size:12px;color:var(--text2);font-family:var(--mono);margin-top:2px;}
.cobro-monto{text-align:right;}
.cobro-cuota{font-size:16px;font-weight:800;color:var(--accent);}
.cobro-mora{font-size:11px;font-family:var(--mono);color:var(--text3);margin-top:2px;}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">COOPERAMIG√ì</div>
    <div class="login-title">Gesti√≥n de Cartera</div>
    <div class="login-sub">Ingresa con tu cuenta autorizada</div>
    <input class="login-input" type="email" id="loginEmail" placeholder="correo@cooperamigo.com" onkeydown="if(event.key==='Enter')doLogin()">
    <input class="login-input" type="password" id="loginPass" placeholder="Contrase√±a" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()" id="loginBtn">Ingresar</button>
    <div class="login-error" id="loginError">Credenciales incorrectas. Intenta de nuevo.</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo-wrap">
      <div class="logo-badge">COOPERAMIG√ì</div>
      <div class="logo-name">Cartera <span>Pro</span></div>
    </div>
    <nav class="nav">
      <div class="nav-section">Principal</div>
      <div class="nav-item active" onclick="goTo('dashboard')">üìä Dashboard</div>
      <div class="nav-item" onclick="goTo('cobros')">üìÖ Cobros de Hoy</div>
      <div class="nav-item" onclick="goTo('alertas')">üîî Alertas <span class="nav-badge" id="badge-alertas">0</span></div>
      <div class="nav-section">Cartera</div>
      <div class="nav-item" onclick="goTo('cartera')">üìã Todos los Cr√©ditos</div>
      <div class="nav-item" onclick="goTo('vencidos')">‚ö†Ô∏è Cr√©ditos Vencidos</div>
      <div class="nav-item" onclick="goTo('rodamiento')">üîÑ Rodamiento</div>
      <div class="nav-section">Gesti√≥n</div>
      <div class="nav-item" onclick="goTo('gestion')">‚úçÔ∏è Gestiones</div>
      <div class="nav-item" onclick="goTo('reportes')">üìÅ Reportes</div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-chip">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-info">
          <div class="user-email" id="userEmail">‚Äî</div>
        </div>
        <button class="logout-btn" onclick="doLogout()" title="Cerrar sesi√≥n">‚èª</button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="page-title" id="pageTitle">Panel de <span>Control</span></div>
      <div class="topbar-right">
        <div class="live-badge"><div class="live-dot"></div> <span id="corteLabel">Sin datos</span></div>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">‚¨Ü Cargar CSV</button>
        <input type="file" id="fileInput" accept=".csv" style="display:none" onchange="handleFile(event)">
      </div>
    </div>

    <!-- DASHBOARD -->
    <div class="section active" id="sec-dashboard">
      <div class="upload-zone" id="uploadZone"
        ondrop="handleDrop(event)" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')"
        onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">üìÇ</div>
        <div class="upload-text"><strong>Arrastra el plano de cartera aqu√≠</strong> o haz clic para seleccionar</div>
        <div class="upload-hint">Columnas: PAGARE ¬∑ CEDULASOCI ¬∑ NOMBRE ¬∑ SALDOCAPIT ¬∑ DIASMORA ¬∑ CATEGORIAF ¬∑ FECHADESEM ¬∑ PLAZO ¬∑ PERIODOCAP ¬∑ ANUALIDAD ¬∑ SALDOPONER ¬∑ TASACOLOCA ¬∑ FORMAPAGO ¬∑ CUOTASMORA ¬∑ RAPORTES ¬∑ NOMBREEMPR ¬∑ NOMBREDEST</div>
      </div>

      <div id="dashContent" style="display:none">
        <div class="kpi-grid">
          <div class="kpi bl"><div class="kpi-label">Cartera Total</div><div class="kpi-val bl" id="k-total">$0</div><div class="kpi-sub" id="k-cred">0 cr√©ditos</div></div>
          <div class="kpi cy"><div class="kpi-label">Asociados</div><div class="kpi-val cy" id="k-asoc">0</div><div class="kpi-sub">deudores √∫nicos</div></div>
          <div class="kpi re"><div class="kpi-label">% de Mora</div><div class="kpi-val re" id="k-pctmora">0%</div><div class="kpi-sub" id="k-saldomora">$0 en mora</div></div>
          <div class="kpi ye"><div class="kpi-label">Por Ponerse al D√≠a</div><div class="kpi-val ye" id="k-poner">$0</div><div class="kpi-sub">saldo total mora</div></div>
          <div class="kpi gr"><div class="kpi-label">Cobros Hoy</div><div class="kpi-val gr" id="k-cobros">0</div><div class="kpi-sub">cr√©ditos con vencimiento</div></div>
        </div>

        <div class="charts-row">
          <div class="card">
            <div class="card-title">Distribuci√≥n por Categor√≠a</div>
            <div class="pie-wrap" id="pieChart"></div>
          </div>
          <div class="card">
            <div class="card-title">Cartera por Rango de Mora</div>
            <div class="bar-rows" id="barChart"></div>
          </div>
        </div>

        <div class="card" style="margin-bottom:16px">
          <div class="card-title">Top 10 ‚Äî Mayor Saldo en Mora</div>
          <div class="table-wrap" style="border:none;border-radius:0">
            <table><thead><tr><th>PAGAR√â</th><th>NOMBRE</th><th>SALDO CAPITAL</th><th>D√çAS MORA</th><th>CAT</th><th>ACCI√ìN</th></tr></thead>
            <tbody id="topMoraBody"></tbody></table>
          </div>
        </div>
      </div>

      <div class="empty" id="dashEmpty">
        <div class="empty-icon">üìä</div>
        <p>Carga el plano de cartera del d√≠a para ver el dashboard</p>
      </div>
    </div>

    <!-- COBROS HOY -->
    <div class="section" id="sec-cobros">
      <div id="cobrosContent"></div>
      <div class="empty" id="cobrosEmpty" style="display:none"><div class="empty-icon">üìÖ</div><p>No hay cr√©ditos con vencimiento hoy</p></div>
    </div>

    <!-- ALERTAS -->
    <div class="section" id="sec-alertas">
      <div class="alert-list" id="alertList"></div>
      <div class="empty" id="alertEmpty" style="display:none"><div class="empty-icon">‚úÖ</div><p>Sin alertas cr√≠ticas. ¬°Cartera saludable!</p></div>
    </div>

    <!-- CARTERA -->
    <div class="section" id="sec-cartera">
      <div class="table-wrap">
        <div class="table-controls">
          <input class="t-search" type="text" placeholder="üîç Buscar nombre, pagar√©, c√©dula..." oninput="filterCartera()" id="srchCartera">
          <select class="t-select" onchange="filterCartera()" id="fCat">
            <option value="">Todas las categor√≠as</option>
            <option value="A">Cat. A (0-30 d√≠as)</option>
            <option value="B">Cat. B (31-60 d√≠as)</option>
            <option value="C">Cat. C (61-90 d√≠as)</option>
            <option value="D">Cat. D (91-180 d√≠as)</option>
            <option value="E">Cat. E (181+ d√≠as)</option>
          </select>
          <select class="t-select" onchange="filterCartera()" id="fPago">
            <option value="">Todas las formas de pago</option>
            <option value="T">Taquilla</option>
            <option value="N">N√≥mina</option>
          </select>
          <select class="t-select" onchange="filterCartera()" id="fPeriodo">
            <option value="">Todos los per√≠odos</option>
            <option value="M">Mensual</option>
            <option value="Q">Quincenal</option>
          </select>
          <div class="t-count"><span id="carteraCount">0</span> registros</div>
        </div>
        <table><thead><tr>
          <th onclick="sortBy('pagare')">PAGAR√â ‚Üï</th>
          <th onclick="sortBy('nombre')">NOMBRE ‚Üï</th>
          <th onclick="sortBy('cedulasoci')">C√âDULA</th>
          <th onclick="sortBy('saldocapit')" class="td-right">SALDO CAPITAL ‚Üï</th>
          <th onclick="sortBy('diasmora')">MORA ‚Üï</th>
          <th>CAT</th>
          <th>FORMA PAGO</th>
          <th onclick="sortBy('tasacoloca')">TASA ‚Üï</th>
          <th>GESTI√ìN</th>
        </tr></thead>
        <tbody id="carteraBody"></tbody></table>
        <div class="pagination" id="carteraPag"></div>
      </div>
      <div class="empty" id="carteraEmpty" style="display:none"><div class="empty-icon">üìã</div><p>Carga el plano para ver los cr√©ditos</p></div>
    </div>

    <!-- VENCIDOS -->
    <div class="section" id="sec-vencidos">
      <div class="table-wrap">
        <table><thead><tr>
          <th>PAGAR√â</th><th>NOMBRE</th><th>C√âDULA</th>
          <th class="td-right">SALDO CAPITAL</th><th>D√çAS VENCIDO</th><th>FECHA VENC.</th><th>CAT</th><th>GESTI√ìN</th>
        </tr></thead>
        <tbody id="vencidosBody"></tbody></table>
      </div>
      <div class="empty" id="vencidosEmpty" style="display:none"><div class="empty-icon">‚úÖ</div><p>No hay cr√©ditos vencidos</p></div>
    </div>

    <!-- RODAMIENTO -->
    <div class="section" id="sec-rodamiento">
      <div class="rod-grid" id="rodGrid"></div>
      <div class="card" style="margin-bottom:16px">
        <div class="card-title">Cr√©ditos que cambian de categor√≠a al cierre del mes</div>
        <div class="table-wrap" style="border:none;border-radius:0;margin-top:12px">
          <table><thead><tr>
            <th>PAGAR√â</th><th>NOMBRE</th><th class="td-right">SALDO</th>
            <th>MORA HOY</th><th>MORA FIN MES</th><th>CAT HOY</th><th>CAT FIN MES</th><th>GESTI√ìN</th>
          </tr></thead>
          <tbody id="rodBody"></tbody></table>
        </div>
      </div>
      <div class="empty" id="rodEmpty" style="display:none"><div class="empty-icon">üéâ</div><p>Ning√∫n cr√©dito cambia de categor√≠a al cierre del mes</p></div>
    </div>

    <!-- GESTI√ìN -->
    <div class="section" id="sec-gestion">
      <div style="display:flex;justify-content:flex-end;margin-bottom:14px">
        <button class="btn btn-primary" onclick="openGestion(null)">+ Nueva Gesti√≥n</button>
      </div>
      <div class="table-wrap">
        <div class="table-controls">
          <input class="t-search" type="text" placeholder="üîç Buscar..." oninput="filterGest()" id="srchGest">
          <select class="t-select" onchange="filterGest()" id="fGestRes">
            <option value="">Todos los resultados</option>
            <option>Pago comprometido</option><option>Sin respuesta</option>
            <option>Acuerdo de pago</option><option>Pago realizado</option>
            <option>No localizado</option><option>Negativa de pago</option>
          </select>
          <div class="t-count"><span id="gestCount">0</span> gestiones</div>
        </div>
        <table><thead><tr>
          <th>FECHA</th><th>PAGAR√â</th><th>NOMBRE</th><th>CANAL</th><th>RESULTADO</th><th>COMPROMISO</th><th>OBSERVACIONES</th><th>GESTOR</th>
        </tr></thead>
        <tbody id="gestBody"></tbody></table>
      </div>
      <div class="empty" id="gestEmpty" style="display:none"><div class="empty-icon">‚úçÔ∏è</div><p>No hay gestiones registradas</p></div>
    </div>

    <!-- REPORTES -->
    <div class="section" id="sec-reportes">
      <div class="report-card"><div class="report-info"><h3>üìä Reporte General de Cartera</h3><p>Todos los cr√©ditos del corte actual</p></div><button class="btn btn-primary" onclick="exportCSV('general')">Descargar CSV</button></div>
      <div class="report-card"><div class="report-info"><h3>‚ö†Ô∏è Cartera en Mora (B, C, D, E)</h3><p>Solo cr√©ditos con d√≠as de mora &gt; 0</p></div><button class="btn btn-primary" onclick="exportCSV('mora')">Descargar CSV</button></div>
      <div class="report-card"><div class="report-info"><h3>üî¥ Cartera de Mayor Riesgo (C, D, E)</h3><p>Cr√©ditos en categor√≠as cr√≠ticas</p></div><button class="btn btn-primary" onclick="exportCSV('riesgo')">Descargar CSV</button></div>
      <div class="report-card"><div class="report-info"><h3>üìÖ Cobros del D√≠a</h3><p>Cr√©ditos con vencimiento hoy</p></div><button class="btn btn-primary" onclick="exportCSV('cobros')">Descargar CSV</button></div>
      <div class="report-card"><div class="report-info"><h3>üîÑ Rodamiento del Mes</h3><p>Cr√©ditos que cambiar√°n de categor√≠a al cierre</p></div><button class="btn btn-primary" onclick="exportCSV('rodamiento')">Descargar CSV</button></div>
      <div class="report-card"><div class="report-info"><h3>‚úçÔ∏è Gestiones Registradas</h3><p>Historial completo de cobros</p></div><button class="btn btn-primary" onclick="exportCSV('gestiones')">Descargar CSV</button></div>
      <div class="report-card"><div class="report-info"><h3>üîî Sin Gesti√≥n Reciente (+7 d√≠as)</h3><p>Mora activa sin gesti√≥n en la √∫ltima semana</p></div><button class="btn btn-primary" onclick="exportCSV('pendiente')">Descargar CSV</button></div>
    </div>

  </main>
</div>

<!-- MODAL GESTI√ìN -->
<div class="modal-overlay" id="gestModal">
  <div class="modal">
    <div class="modal-title">Registrar Gesti√≥n</div>
    <div class="modal-sub" id="gestModalSub">Nueva gesti√≥n de cobro</div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Pagar√©</label><input class="form-input" id="g-pagare" placeholder="N√∫mero de pagar√©"></div>
      <div class="form-group"><label class="form-label">Nombre deudor</label><input class="form-input" id="g-nombre" placeholder="Nombre completo"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha de gesti√≥n</label><input class="form-input" type="date" id="g-fecha"></div>
      <div class="form-group"><label class="form-label">Canal</label>
        <select class="form-select" id="g-canal">
          <option>Llamada telef√≥nica</option><option>Visita domiciliaria</option><option>WhatsApp</option>
          <option>Correo electr√≥nico</option><option>Mensaje de texto</option><option>Carta</option><option>Presencial en oficina</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Resultado</label>
        <select class="form-select" id="g-resultado">
          <option>Pago comprometido</option><option>Sin respuesta</option><option>Acuerdo de pago</option>
          <option>Pago realizado</option><option>No localizado</option><option>Negativa de pago</option><option>N√∫mero equivocado</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Fecha compromiso</label><input class="form-input" type="date" id="g-compromiso"></div>
    </div>
    <div class="form-group"><label class="form-label">Monto comprometido</label><input class="form-input" type="number" id="g-monto" placeholder="0"></div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-textarea" id="g-obs" placeholder="Notas de la gesti√≥n..."></textarea></div>
    <div class="form-group"><label class="form-label">Gestor</label><input class="form-input" id="g-gestor" placeholder="Nombre del gestor"></div>
    <div id="historialWrap" style="display:none">
      <div class="hist-list"><div class="hist-title">HISTORIAL DE GESTIONES</div><div id="historialList"></div></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('gestModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveGestion()">Guardar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ==================== SUPABASE ====================
const SUPA_URL = 'https://tmpcwwprxrnbheodgkve.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcGN3d3ByeHJuYmhlb2Rna3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTI4NzQsImV4cCI6MjA4NzE2ODg3NH0.CimJjOJb0J3zqfelk-R3ZYJgfzKLsDnmXEiAURvuzIo';
const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

// ==================== STATE ====================
let cartera = [];
let gestiones = [];
let filteredCartera = [];
let filteredGest = [];
let sortCol = 'diasmora', sortDir = -1;
let page = 1;
const PAGE = 20;
let fechaCorte = null;

// ==================== AUTH ====================
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPass').value;
  const btn   = document.getElementById('loginBtn');
  const err   = document.getElementById('loginError');
  err.style.display = 'none';
  btn.innerHTML = '<span class="loading"></span>';
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) {
    err.style.display = 'block';
    btn.textContent = 'Ingresar';
  } else {
    initApp();
  }
}

async function doLogout() {
  await sb.auth.signOut();
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginPass').value = '';
}

async function checkSession() {
  const { data } = await sb.auth.getSession();
  if (data.session) initApp();
}

async function initApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  const { data } = await sb.auth.getUser();
  if (data.user) {
    const email = data.user.email;
    document.getElementById('userEmail').textContent = email;
    document.getElementById('userAvatar').textContent = email[0].toUpperCase();
  }
  document.getElementById('g-fecha').value = today();
  await loadFromSupabase();
}

// ==================== LOAD DATA ====================
async function loadFromSupabase() {
  // Cargar cartera del √∫ltimo corte
  const { data: carr } = await sb.from('cartera').select('*').order('diasmora', { ascending: false });
  if (carr && carr.length > 0) {
    cartera = carr;
    fechaCorte = carr[0].fecha_corte;
    document.getElementById('corteLabel').textContent = 'Corte: ' + fmtDate(fechaCorte);
    document.getElementById('uploadZone').classList.add('loaded');
    document.getElementById('uploadZone').innerHTML = `
      <div class="upload-icon">‚úÖ</div>
      <div class="upload-text"><strong>Cartera cargada</strong> ‚Äî ${carr.length} cr√©ditos</div>
      <div class="corte-badge">üìÖ Corte: ${fmtDate(fechaCorte)}</div>
      <div class="upload-hint" style="margin-top:12px">Haz clic o arrastra un nuevo CSV para actualizar</div>`;
    document.getElementById('uploadZone').onclick = () => document.getElementById('fileInput').click();
    renderDashboard();
  }

  // Cargar gestiones
  const { data: gest } = await sb.from('gestiones').select('*').order('created_at', { ascending: false });
  if (gest) gestiones = gest;
  renderGestiones();
}

// ==================== FILE HANDLING ====================
function handleDrop(e) {
  e.preventDefault();
  document.getElementById('uploadZone').classList.remove('drag');
  processFile(e.dataTransfer.files[0]);
}
function handleFile(e) { processFile(e.target.files[0]); e.target.value=''; }

function processFile(file) {
  if (!file || !file.name.endsWith('.csv')) { showToast('Solo se aceptan archivos CSV', 'err'); return; }
  const reader = new FileReader();
  reader.onload = e => parseAndUpload(e.target.result, file.name);
  reader.readAsText(file, 'UTF-8');
}

async function parseAndUpload(text, filename) {
  showToast('Procesando archivo...', 'ok');
  const lines = text.trim().split('\n');
  if (lines.length < 2) { showToast('Archivo vac√≠o', 'err'); return; }

  const sep = lines[0].includes(';') ? ';' : lines[0].includes('	') ? '	' : ',';
  const headers = lines[0].split(sep).map(h => h.trim().replace(/"/g,'').toUpperCase());

  const col = name => {
    const variants = {
      pagare:     ['PAGARE'],
      cedulasoci: ['CEDULASOCI','CEDULA','CC'],
      nombre:     ['NOMBRE'],
      nombreempr: ['NOMBREEMPR','EMPRESA'],
      nombredest: ['NOMBREDEST','CORREO','EMAIL'],
      raportes:   ['RAPORTES'],
      anualidad:  ['ANUALIDAD','CUOTA'],
      fechadesem: ['FECHADESEM','FECHADESEMB'],
      saldocapit: ['SALDOCAPIT','SALDO'],
      plazo:      ['PLAZO'],
      tasacoloca: ['TASACOLOCA','TASA'],
      formapago:  ['FORMAPAGO'],
      periodocap: ['PERIODOCAP'],
      diasmora:   ['DIASMORA'],
      cuotasmora: ['CUOTASMORA'],
      saldoponer: ['SALDOPONER'],
      categoriaf: ['CATEGORIAF','CATEGORIA','CAT'],
    };
    for (const v of (variants[name] || [name])) {
      const i = headers.findIndex(h => h.includes(v) || v.includes(h));
      if (i !== -1) return i;
    }
    return -1;
  };

  const get = (vals, name) => {
    const i = col(name);
    return i !== -1 ? (vals[i] || '').trim().replace(/"/g,'') : '';
  };

  const hoyDate = today();
  const registros = [];

  for (let i = 1; i < lines.length; i++) {
    const vals = lines[i].split(sep);
    if (vals.join('').trim() === '') continue;
    const pagare = get(vals,'pagare');
    if (!pagare) continue;

    const diasmora = parseInt(get(vals,'diasmora')) || 0;
    const catRaw = get(vals,'categoriaf').toUpperCase();
    const cat = ['A','B','C','D','E'].includes(catRaw) ? catRaw : calcCat(diasmora);

    registros.push({
      pagare,
      cedulasoci:  get(vals,'cedulasoci'),
      nombre:      get(vals,'nombre'),
      nombreempr:  get(vals,'nombreempr'),
      nombredest:  get(vals,'nombredest'),
      raportes:    parseNum(get(vals,'raportes')),
      anualidad:   parseNum(get(vals,'anualidad')),
      fechadesem:  parseDate(get(vals,'fechadesem')),
      saldocapit:  parseNum(get(vals,'saldocapit')),
      plazo:       parseInt(get(vals,'plazo')) || 0,
      tasacoloca:  parseNum(get(vals,'tasacoloca')),
      formapago:   get(vals,'formapago').toUpperCase(),
      periodocap:  get(vals,'periodocap').toUpperCase(),
      diasmora,
      cuotasmora:  parseNum(get(vals,'cuotasmora')),
      saldoponer:  parseNum(get(vals,'saldoponer')),
      categoriaf:  cat,
      fecha_corte: hoyDate,
    });
  }

  if (registros.length === 0) { showToast('No se encontraron registros v√°lidos', 'err'); return; }

  // Upsert en Supabase por lotes de 500
  const BATCH = 500;
  for (let i = 0; i < registros.length; i += BATCH) {
    const lote = registros.slice(i, i + BATCH);
    const { error } = await sb.from('cartera').upsert(lote, { onConflict: 'pagare' });
    if (error) { showToast('Error guardando: ' + error.message, 'err'); return; }
  }

  // Tambi√©n guardar en hist√≥rico
  const hist = registros.map(r => ({
    pagare: r.pagare, cedulasoci: r.cedulasoci, nombre: r.nombre,
    saldocapit: r.saldocapit, saldoponer: r.saldoponer,
    diasmora: r.diasmora, cuotasmora: r.cuotasmora,
    categoriaf: r.categoriaf, fecha_corte: r.fecha_corte,
  }));
  for (let i = 0; i < hist.length; i += BATCH) {
    await sb.from('cartera_historico').upsert(hist.slice(i, i+BATCH), { ignoreDuplicates: true });
  }

  // Log de carga
  const saldoTotal = registros.reduce((a,r)=>a+r.saldocapit,0);
  const saldoMora  = registros.filter(r=>['B','C','D','E'].includes(r.categoriaf)).reduce((a,r)=>a+r.saldocapit,0);
  await sb.from('cargas_log').insert({
    fecha_corte: hoyDate,
    total_creditos: registros.length,
    total_asociados: new Set(registros.map(r=>r.cedulasoci)).size,
    saldo_total: saldoTotal,
    saldo_mora: saldoMora,
    pct_mora: saldoTotal ? Math.round(saldoMora/saldoTotal*10000)/100 : 0,
    creditos_a: registros.filter(r=>r.categoriaf==='A').length,
    creditos_b: registros.filter(r=>r.categoriaf==='B').length,
    creditos_c: registros.filter(r=>r.categoriaf==='C').length,
    creditos_d: registros.filter(r=>r.categoriaf==='D').length,
    creditos_e: registros.filter(r=>r.categoriaf==='E').length,
    archivo_nombre: filename,
  });

  cartera = registros;
  fechaCorte = hoyDate;
  document.getElementById('corteLabel').textContent = 'Corte: ' + fmtDate(hoyDate);
  showToast(`‚úÖ ${registros.length} cr√©ditos cargados a Supabase`, 'ok');
  renderDashboard();
  renderCartera();
  renderGestiones();
}

// ==================== DASHBOARD ====================
function renderDashboard() {
  if (!cartera.length) return;
  document.getElementById('dashContent').style.display = 'block';
  document.getElementById('dashEmpty').style.display = 'none';

  const total    = cartera.reduce((a,r)=>a+r.saldocapit, 0);
  const mora     = cartera.filter(r=>['B','C','D','E'].includes(r.categoriaf)).reduce((a,r)=>a+r.saldocapit,0);
  const poner    = cartera.reduce((a,r)=>a+r.saldoponer,0);
  const asoc     = new Set(cartera.map(r=>r.cedulasoci)).size;
  const cobros   = cobrosHoy().length;
  const alertCnt = cartera.filter(r=>['C','D','E'].includes(r.categoriaf)).length;

  document.getElementById('k-total').textContent    = cop(total);
  document.getElementById('k-cred').textContent     = `${cartera.length} cr√©ditos`;
  document.getElementById('k-asoc').textContent     = asoc;
  document.getElementById('k-pctmora').textContent  = pct(mora, total) + '%';
  document.getElementById('k-saldomora').textContent= cop(mora) + ' en mora';
  document.getElementById('k-poner').textContent    = cop(poner);
  document.getElementById('k-cobros').textContent   = cobros;
  document.getElementById('badge-alertas').textContent = alertCnt;

  renderPie();
  renderBar();
  renderTopMora();
}

function renderPie() {
  const cats = {A:0,B:0,C:0,D:0,E:0};
  cartera.forEach(r => cats[r.categoriaf] = (cats[r.categoriaf]||0)+1);
  const total = cartera.length;
  const colors = {A:'#22c55e',B:'#eab308',C:'#f97316',D:'#ef4444',E:'#dc2626'};
  const segs = Object.entries(cats).filter(([,v])=>v>0);
  let start = 0;
  const paths = segs.map(([cat,cnt]) => {
    const angle = cnt/total*360;
    const a1 = (start-90)*Math.PI/180;
    const a2 = (start+angle-90)*Math.PI/180;
    const r=55,cx=65,cy=65;
    const x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
    const x2=cx+r*Math.cos(a2),y2=cy+r*Math.sin(a2);
    const large = angle>180?1:0;
    start += angle;
    return `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z" fill="${colors[cat]}" opacity=".8"/>`;
  }).join('');

  const legend = segs.map(([cat,cnt])=>`
    <div class="pie-leg"><div class="pie-dot" style="background:${colors[cat]}"></div>
    Cat. ${cat}: ${cnt} <span style="color:var(--text3)">(${pct(cnt,total)}%)</span></div>`).join('');

  document.getElementById('pieChart').innerHTML = `
    <svg width="130" height="130" viewBox="0 0 130 130" style="flex-shrink:0">
      ${paths}
      <circle cx="65" cy="65" r="28" fill="var(--s1)"/>
      <text x="65" y="65" text-anchor="middle" fill="var(--text)" font-size="12" font-family="var(--mono)" dy="4">${total}</text>
    </svg>
    <div class="pie-legend">${legend}</div>`;
}

function renderBar() {
  const ranges = [
    {label:'A',min:0,max:30,color:'#22c55e'},
    {label:'B',min:31,max:60,color:'#eab308'},
    {label:'C',min:61,max:90,color:'#f97316'},
    {label:'D',min:91,max:180,color:'#ef4444'},
    {label:'E',min:181,max:99999,color:'#dc2626'},
  ];
  const counts = ranges.map(r=>({...r, cnt: cartera.filter(c=>c.diasmora>=r.min&&c.diasmora<=r.max).length, saldo: cartera.filter(c=>c.diasmora>=r.min&&c.diasmora<=r.max).reduce((a,c)=>a+c.saldocapit,0)}));
  const max = Math.max(...counts.map(c=>c.cnt),1);
  document.getElementById('barChart').innerHTML = counts.map(r=>`
    <div class="bar-row">
      <div class="bar-label">Cat ${r.label}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(r.cnt/max*100).toFixed(1)}%;background:${r.color}"></div></div>
      <div class="bar-info">${r.cnt} ¬∑ ${cop(r.saldo)}</div>
    </div>`).join('');
}

function renderTopMora() {
  const top = [...cartera].filter(r=>r.diasmora>0).sort((a,b)=>b.saldocapit-a.saldocapit).slice(0,10);
  document.getElementById('topMoraBody').innerHTML = top.map(r=>`
    <tr>
      <td class="td-mono">${r.pagare}</td>
      <td>${r.nombre}</td>
      <td class="td-right td-mono">${cop(r.saldocapit)}</td>
      <td>${moraBadge(r.diasmora)}</td>
      <td><span class="cat-badge cat-${r.categoriaf}">${r.categoriaf}</span></td>
      <td><button class="btn btn-outline btn-sm" onclick="openGestion('${r.pagare}')">Gestionar</button></td>
    </tr>`).join('') || '<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text3)">Sin mora</td></tr>';
}

// ==================== COBROS HOY ====================
function cobrosHoy() {
  const hoy = new Date();
  const diaHoy = hoy.getDate();
  return cartera.filter(r => {
    if (!r.fechadesem) return false;
    const fd = new Date(r.fechadesem);
    const diaDesem = fd.getDate();
    if (r.periodocap === 'M') return diaDesem === diaHoy;
    if (r.periodocap === 'Q') {
      const diaQ = new Date(fd.getTime() + 15*864e5).getDate();
      return diaDesem === diaHoy || diaQ === diaHoy;
    }
    return false;
  });
}

function renderCobros() {
  const lista = cobrosHoy();
  const wrap = document.getElementById('cobrosContent');
  document.getElementById('cobrosEmpty').style.display = lista.length ? 'none' : 'block';
  if (!lista.length) { wrap.innerHTML=''; return; }

  const total = lista.reduce((a,r)=>a+r.anualidad,0);
  wrap.innerHTML = `
    <div style="display:flex;gap:12px;margin-bottom:18px">
      <div class="kpi bl" style="flex:1"><div class="kpi-label">Cr√©ditos a cobrar hoy</div><div class="kpi-val bl">${lista.length}</div></div>
      <div class="kpi gr" style="flex:1"><div class="kpi-label">Total cuotas del d√≠a</div><div class="kpi-val gr">${cop(total)}</div></div>
      <div class="kpi ye" style="flex:1"><div class="kpi-label">Con mora activa</div><div class="kpi-val ye">${lista.filter(r=>r.diasmora>0).length}</div></div>
    </div>
    ${lista.sort((a,b)=>b.diasmora-a.diasmora).map(r=>`
      <div class="cobro-card">
        <div class="cobro-icon">${r.formapago==='N'?'üè¢':'üè¶'}</div>
        <div class="cobro-body">
          <div class="cobro-nombre">${r.nombre}</div>
          <div class="cobro-detail">${r.pagare} ¬∑ ${r.cedulasoci} ¬∑ ${r.formapago==='N'?'N√≥mina':'Taquilla'} ¬∑ ${r.periodocap==='Q'?'Quincenal':'Mensual'}</div>
          ${r.nombredest ? `<div class="cobro-detail" style="color:var(--accent2)">‚úâ ${r.nombredest}</div>` : ''}
        </div>
        <div class="cobro-monto">
          <div class="cobro-cuota">${cop(r.anualidad)}</div>
          <div class="cobro-mora">${r.diasmora>0?moraBadge(r.diasmora):'<span class="mora-badge mora-0">Al d√≠a</span>'}</div>
          ${r.saldoponer>0?`<div style="font-family:var(--mono);font-size:10px;color:var(--red);margin-top:3px">Poner al d√≠a: ${cop(r.saldoponer)}</div>`:''}
        </div>
        <button class="btn btn-outline btn-sm" onclick="openGestion('${r.pagare}')">Gestionar</button>
      </div>`).join('')}`;
}

// ==================== ALERTAS ====================
function renderAlertas() {
  const alerts = [];
  cartera.filter(r=>r.categoriaf==='E').forEach(r=>alerts.push({type:'crit',icon:'üî¥',name:r.nombre,detail:`${r.pagare} ¬∑ ${r.diasmora} d√≠as mora ¬∑ ${cop(r.saldocapit)}`,pagare:r.pagare}));
  cartera.filter(r=>r.categoriaf==='D').forEach(r=>alerts.push({type:'crit',icon:'üü†',name:r.nombre,detail:`${r.pagare} ¬∑ ${r.diasmora} d√≠as mora ¬∑ ${cop(r.saldocapit)}`,pagare:r.pagare}));
  cartera.filter(r=>r.categoriaf==='C').forEach(r=>alerts.push({type:'warn',icon:'üü°',name:r.nombre,detail:`${r.pagare} ¬∑ ${r.diasmora} d√≠as mora ¬∑ ${cop(r.saldocapit)}`,pagare:r.pagare}));

  const hoy = new Date();
  cartera.filter(r=>r.diasmora>0 && r.categoriaf!=='C'&&r.categoriaf!=='D'&&r.categoriaf!=='E').forEach(r=>{
    const ultGest = gestiones.filter(g=>g.pagare===r.pagare).sort((a,b)=>new Date(b.fecha_gestion)-new Date(a.fecha_gestion))[0];
    if (!ultGest || (hoy-new Date(ultGest.fecha_gestion))/864e5>7) {
      alerts.push({type:'info',icon:'üîµ',name:r.nombre,detail:`${r.pagare} ¬∑ Sin gesti√≥n reciente ¬∑ ${r.diasmora} d√≠as mora`,pagare:r.pagare});
    }
  });

  document.getElementById('badge-alertas').textContent = alerts.length;
  document.getElementById('alertEmpty').style.display = alerts.length?'none':'block';
  document.getElementById('alertList').innerHTML = alerts.map(a=>`
    <div class="alert-item ${a.type}">
      <span style="font-size:20px">${a.icon}</span>
      <div class="alert-body"><div class="alert-name">${a.name}</div><div class="alert-detail">${a.detail}</div></div>
      <button class="btn btn-outline btn-sm" onclick="openGestion('${a.pagare}')">Gestionar</button>
    </div>`).join('');
}

// ==================== CARTERA TABLE ====================
function renderCartera() {
  filteredCartera = applyFilters();
  const start = (page-1)*PAGE;
  const slice = filteredCartera.slice(start, start+PAGE);
  document.getElementById('carteraCount').textContent = filteredCartera.length;
  document.getElementById('carteraEmpty').style.display = filteredCartera.length?'none':'block';
  document.getElementById('carteraBody').innerHTML = slice.map(r=>`
    <tr>
      <td class="td-mono">${r.pagare}</td>
      <td>${r.nombre}</td>
      <td class="td-mono">${r.cedulasoci}</td>
      <td class="td-right td-mono">${cop(r.saldocapit)}</td>
      <td>${moraBadge(r.diasmora)}</td>
      <td><span class="cat-badge cat-${r.categoriaf}">${r.categoriaf}</span></td>
      <td><span class="formapago-badge fp-${r.formapago}">${r.formapago==='N'?'N√≥mina':r.formapago==='T'?'Taquilla':r.formapago}</span></td>
      <td class="td-mono">${r.tasacoloca?r.tasacoloca.toFixed(2)+'%':'-'}</td>
      <td><button class="btn btn-outline btn-sm" onclick="openGestion('${r.pagare}')">Gestionar</button></td>
    </tr>`).join('') || '<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text3)">Sin resultados</td></tr>';
  renderPag();
}

function applyFilters() {
  let data = [...cartera];
  const s = document.getElementById('srchCartera').value.toLowerCase();
  const cat = document.getElementById('fCat').value;
  const fp = document.getElementById('fPago').value;
  const per = document.getElementById('fPeriodo').value;
  if (s) data = data.filter(r=>r.nombre?.toLowerCase().includes(s)||r.pagare?.toLowerCase().includes(s)||r.cedulasoci?.includes(s));
  if (cat) data = data.filter(r=>r.categoriaf===cat);
  if (fp) data = data.filter(r=>r.formapago===fp);
  if (per) data = data.filter(r=>r.periodocap===per);
  data.sort((a,b)=>{
    let va=a[sortCol],vb=b[sortCol];
    if (typeof va==='string') return sortDir*va.localeCompare(vb||'');
    return sortDir*((va||0)-(vb||0));
  });
  return data;
}

function filterCartera() { page=1; renderCartera(); }
function sortBy(col) { if(sortCol===col)sortDir*=-1; else{sortCol=col;sortDir=-1;} renderCartera(); }

function renderPag() {
  const total = Math.ceil(filteredCartera.length/PAGE);
  if (total<=1){document.getElementById('carteraPag').innerHTML='';return;}
  let html = `<span class="pg-info">${(page-1)*PAGE+1}‚Äì${Math.min(page*PAGE,filteredCartera.length)} de ${filteredCartera.length}</span>`;
  html += `<button class="pg-btn" onclick="changePage(${page-1})" ${page===1?'disabled':''}>‚Äπ</button>`;
  for(let i=1;i<=total;i++){
    if(i===1||i===total||Math.abs(i-page)<=1) html+=`<button class="pg-btn ${i===page?'active':''}" onclick="changePage(${i})">${i}</button>`;
    else if(Math.abs(i-page)===2) html+=`<span class="pg-info">‚Ä¶</span>`;
  }
  html+=`<button class="pg-btn" onclick="changePage(${page+1})" ${page===total?'disabled':''}>‚Ä∫</button>`;
  document.getElementById('carteraPag').innerHTML=html;
}
function changePage(p){const t=Math.ceil(filteredCartera.length/PAGE);if(p<1||p>t)return;page=p;renderCartera();}

// ==================== VENCIDOS ====================
function renderVencidos() {
  const hoy = new Date();
  const venc = cartera.filter(r=>{
    if(!r.fechadesem||!r.plazo) return false;
    const fd=new Date(r.fechadesem);
    let fv;
    if(r.periodocap==='M') fv=new Date(fd.setMonth(fd.getMonth()+r.plazo));
    else fv=new Date(fd.getTime()+r.plazo*15*864e5);
    return fv<hoy;
  }).map(r=>{
    const fd=new Date(r.fechadesem);
    let fv;
    if(r.periodocap==='M'){const d=new Date(fd);d.setMonth(d.getMonth()+r.plazo);fv=d;}
    else fv=new Date(fd.getTime()+r.plazo*15*864e5);
    const diasVenc=Math.floor((hoy-fv)/864e5);
    return {...r,fv,diasVenc};
  }).sort((a,b)=>b.diasVenc-a.diasVenc);

  document.getElementById('vencidosEmpty').style.display=venc.length?'none':'block';
  document.getElementById('vencidosBody').innerHTML=venc.map(r=>`
    <tr>
      <td class="td-mono">${r.pagare}</td>
      <td>${r.nombre}</td>
      <td class="td-mono">${r.cedulasoci}</td>
      <td class="td-right td-mono">${cop(r.saldocapit)}</td>
      <td><span class="mora-badge mora-e">${r.diasVenc} d√≠as</span></td>
      <td class="td-mono">${fmtDate(r.fv.toISOString().split('T')[0])}</td>
      <td><span class="cat-badge cat-${r.categoriaf}">${r.categoriaf}</span></td>
      <td><button class="btn btn-outline btn-sm" onclick="openGestion('${r.pagare}')">Gestionar</button></td>
    </tr>`).join('')||'<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text3)">Sin vencidos</td></tr>';
}

// ==================== RODAMIENTO ====================
function renderRodamiento() {
  const hoy = new Date();
  const finMes = new Date(hoy.getFullYear(), hoy.getMonth()+1, 0);
  const diasRestantes = Math.floor((finMes-hoy)/864e5);

  const transiciones = [{de:'A',a:'B'},{de:'B',a:'C'},{de:'C',a:'D'},{de:'D',a:'E'}];
  const limits = {A:[0,30],B:[31,60],C:[61,90],D:[91,180],E:[181,99999]};

  const rodamiento = cartera.filter(r=>r.diasmora>0).map(r=>{
    const proyectado = r.diasmora + diasRestantes;
    const catFin = calcCat(proyectado);
    return {...r, proyectado, catFin};
  }).filter(r=>r.categoriaf!==r.catFin);

  // Grid de transiciones
  document.getElementById('rodGrid').innerHTML = transiciones.map(t=>{
    const grupo = rodamiento.filter(r=>r.categoriaf===t.de&&r.catFin===t.a);
    const saldo = grupo.reduce((a,r)=>a+r.saldocapit,0);
    const colors={A:'#22c55e',B:'#eab308',C:'#f97316',D:'#ef4444',E:'#dc2626'};
    return `<div class="rod-card">
      <div class="rod-arrow">
        <span style="color:${colors[t.de]}">${t.de}</span> ‚Üí <span style="color:${colors[t.a]}">${t.a}</span>
      </div>
      <div class="rod-label">PASAN DE ${t.de} A ${t.a}</div>
      <div class="rod-count" style="color:${colors[t.a]}">${grupo.length}</div>
      <div class="rod-saldo">${cop(saldo)}</div>
    </div>`;
  }).join('');

  document.getElementById('rodEmpty').style.display = rodamiento.length?'none':'block';
  document.getElementById('rodBody').innerHTML = rodamiento.sort((a,b)=>b.saldocapit-a.saldocapit).map(r=>`
    <tr>
      <td class="td-mono">${r.pagare}</td>
      <td>${r.nombre}</td>
      <td class="td-right td-mono">${cop(r.saldocapit)}</td>
      <td>${moraBadge(r.diasmora)}</td>
      <td><span class="mora-badge mora-${r.catFin==='B'?'b':r.catFin==='C'?'c':r.catFin==='D'?'d':'e'}">${r.proyectado} d√≠as</span></td>
      <td><span class="cat-badge cat-${r.categoriaf}">${r.categoriaf}</span></td>
      <td><span class="cat-badge cat-${r.catFin}">${r.catFin}</span></td>
      <td><button class="btn btn-outline btn-sm" onclick="openGestion('${r.pagare}')">Gestionar</button></td>
    </tr>`).join('');
}

// ==================== GESTIONES ====================
async function renderGestiones() {
  if (!gestiones.length) {
    const { data } = await sb.from('gestiones').select('*').order('created_at',{ascending:false});
    if (data) gestiones = data;
  }
  filterGest();
}

function filterGest() {
  const s = document.getElementById('srchGest').value.toLowerCase();
  const res = document.getElementById('fGestRes').value;
  filteredGest = gestiones.filter(g=>{
    const matchS = !s || g.nombre_deudor?.toLowerCase().includes(s) || g.pagare?.includes(s);
    const matchR = !res || g.resultado===res;
    return matchS && matchR;
  });
  document.getElementById('gestCount').textContent = filteredGest.length;
  document.getElementById('gestEmpty').style.display = filteredGest.length?'none':'block';
  const resColors={'Pago comprometido':'#eab308','Sin respuesta':'#475569','Acuerdo de pago':'#3b82f6','Pago realizado':'#22c55e','No localizado':'#f97316','Negativa de pago':'#ef4444','N√∫mero equivocado':'#475569'};
  document.getElementById('gestBody').innerHTML = filteredGest.map(g=>`
    <tr>
      <td class="td-mono">${g.fecha_gestion}</td>
      <td class="td-mono">${g.pagare||'‚Äî'}</td>
      <td>${g.nombre_deudor||'‚Äî'}</td>
      <td>${g.canal||'‚Äî'}</td>
      <td><span style="color:${resColors[g.resultado]||'#94a3b8'};font-family:var(--mono);font-size:11px">${g.resultado||'‚Äî'}</span></td>
      <td class="td-mono">${g.fecha_compromiso||'‚Äî'}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${g.observaciones||'‚Äî'}</td>
      <td>${g.gestor||'‚Äî'}</td>
    </tr>`).join('');
}

function openGestion(pagare) {
  document.getElementById('g-fecha').value = today();
  document.getElementById('g-compromiso').value = '';
  document.getElementById('g-monto').value = '';
  document.getElementById('g-obs').value = '';
  document.getElementById('g-gestor').value = '';

  if (pagare) {
    const c = cartera.find(r=>r.pagare===pagare);
    document.getElementById('g-pagare').value = pagare;
    document.getElementById('g-nombre').value = c?.nombre||'';
    document.getElementById('gestModalSub').textContent = c ? `${c.nombre} ¬∑ ${cop(c.saldocapit)} ¬∑ ${c.diasmora} d√≠as mora` : pagare;
    const hist = gestiones.filter(g=>g.pagare===pagare).sort((a,b)=>new Date(b.fecha_gestion)-new Date(a.fecha_gestion)).slice(0,5);
    if (hist.length) {
      document.getElementById('historialWrap').style.display='block';
      document.getElementById('historialList').innerHTML=hist.map(g=>`
        <div class="hist-item">
          <div class="hist-date">${g.fecha_gestion} ¬∑ ${g.canal}</div>
          <div class="hist-text">${g.observaciones||'Sin observaciones'}</div>
          <div class="hist-res">Resultado: ${g.resultado}${g.fecha_compromiso?' ¬∑ Compromiso: '+g.fecha_compromiso:''}</div>
        </div>`).join('');
    } else document.getElementById('historialWrap').style.display='none';
  } else {
    document.getElementById('g-pagare').value='';
    document.getElementById('g-nombre').value='';
    document.getElementById('gestModalSub').textContent='Nueva gesti√≥n de cobro';
    document.getElementById('historialWrap').style.display='none';
  }
  document.getElementById('gestModal').classList.add('open');
}

async function saveGestion() {
  const pagare = document.getElementById('g-pagare').value.trim();
  const nombre = document.getElementById('g-nombre').value.trim();
  if (!pagare) { showToast('Ingresa el n√∫mero de pagar√©', 'err'); return; }
  const c = cartera.find(r=>r.pagare===pagare);
  const gestion = {
    pagare,
    cedulasoci: c?.cedulasoci||null,
    nombre_deudor: nombre||c?.nombre||null,
    fecha_gestion: document.getElementById('g-fecha').value,
    canal: document.getElementById('g-canal').value,
    resultado: document.getElementById('g-resultado').value,
    fecha_compromiso: document.getElementById('g-compromiso').value||null,
    monto_comprometido: parseFloat(document.getElementById('g-monto').value)||null,
    observaciones: document.getElementById('g-obs').value||null,
    gestor: document.getElementById('g-gestor').value||null,
  };
  const { error } = await sb.from('gestiones').insert(gestion);
  if (error) { showToast('Error: ' + error.message, 'err'); return; }
  gestiones.unshift(gestion);
  closeModal('gestModal');
  showToast('‚úÖ Gesti√≥n guardada', 'ok');
  filterGest();
}

// ==================== EXPORTS ====================
function exportCSV(type) {
  let data, headers, rows;
  const hoy=new Date();
  const finMes=new Date(hoy.getFullYear(),hoy.getMonth()+1,0);
  const diasRestantes=Math.floor((finMes-hoy)/864e5);

  if (type==='general') { data=cartera; headers=['PAGARE','NOMBRE','CEDULASOCI','CATEGORIAF','SALDOCAPIT','DIASMORA','SALDOPONER','ANUALIDAD','FORMAPAGO','PERIODOCAP','TASACOLOCA','FECHADESEM','PLAZO']; }
  else if (type==='mora') { data=cartera.filter(r=>r.diasmora>0); headers=['PAGARE','NOMBRE','CEDULASOCI','CATEGORIAF','SALDOCAPIT','DIASMORA','SALDOPONER']; }
  else if (type==='riesgo') { data=cartera.filter(r=>['C','D','E'].includes(r.categoriaf)); headers=['PAGARE','NOMBRE','CEDULASOCI','CATEGORIAF','SALDOCAPIT','DIASMORA','SALDOPONER']; }
  else if (type==='cobros') { data=cobrosHoy(); headers=['PAGARE','NOMBRE','CEDULASOCI','ANUALIDAD','SALDOPONER','DIASMORA','CATEGORIAF','NOMBREDEST','FORMAPAGO']; }
  else if (type==='rodamiento') {
    data=cartera.filter(r=>r.diasmora>0).map(r=>({...r,proyectado:r.diasmora+diasRestantes,catFin:calcCat(r.diasmora+diasRestantes)})).filter(r=>r.categoriaf!==r.catFin);
    headers=['PAGARE','NOMBRE','CEDULASOCI','SALDOCAPIT','DIASMORA','CATEGORIA_ACTUAL','DIAS_FIN_MES','CATEGORIA_FIN_MES'];
    rows=[headers,...data.map(r=>[r.pagare,r.nombre,r.cedulasoci,r.saldocapit,r.diasmora,r.categoriaf,r.proyectado,r.catFin])];
    return dlCSV(rows, 'rodamiento.csv');
  }
  else if (type==='gestiones') {
    rows=[['FECHA','PAGARE','NOMBRE','CANAL','RESULTADO','COMPROMISO','MONTO','OBSERVACIONES','GESTOR'],...gestiones.map(g=>[g.fecha_gestion,g.pagare,g.nombre_deudor,g.canal,g.resultado,g.fecha_compromiso,g.monto_comprometido,g.observaciones,g.gestor])];
    return dlCSV(rows, 'gestiones.csv');
  }
  else if (type==='pendiente') {
    data=cartera.filter(r=>r.diasmora>0).filter(r=>{
      const ult=gestiones.filter(g=>g.pagare===r.pagare).sort((a,b)=>new Date(b.fecha_gestion)-new Date(a.fecha_gestion))[0];
      return !ult||(hoy-new Date(ult.fecha_gestion))/864e5>7;
    });
    headers=['PAGARE','NOMBRE','CEDULASOCI','CATEGORIAF','SALDOCAPIT','DIASMORA','SALDOPONER'];
  }

  rows=[headers,...data.map(r=>headers.map(h=>r[h.toLowerCase()]??''))];
  dlCSV(rows, type+'.csv');
}

function dlCSV(rows, name) {
  const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'}));
  a.download=name; a.click();
}

// ==================== NAV ====================
const titles = {
  dashboard:'Panel de <span>Control</span>',
  cobros:'Cobros de <span>Hoy</span>',
  alertas:'<span>Alertas</span> Autom√°ticas',
  cartera:'Gesti√≥n de <span>Cartera</span>',
  vencidos:'Cr√©ditos <span>Vencidos</span>',
  rodamiento:'<span>Rodamiento</span> de Cartera',
  gestion:'Registro de <span>Gestiones</span>',
  reportes:'<span>Reportes</span>',
};

function goTo(name) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>{if(n.textContent.includes(name.charAt(0).toUpperCase()+name.slice(1))||n.textContent.toLowerCase().includes(name))n.classList.add('active');});
  document.getElementById('pageTitle').innerHTML = titles[name]||name;
  if(name==='cartera') renderCartera();
  if(name==='cobros') renderCobros();
  if(name==='alertas') renderAlertas();
  if(name==='vencidos') renderVencidos();
  if(name==='rodamiento') renderRodamiento();
  if(name==='gestion') renderGestiones();
}

// ==================== UTILS ====================
function calcCat(dias) {
  if(dias<=0) return 'A';
  if(dias<=30) return 'A';
  if(dias<=60) return 'B';
  if(dias<=90) return 'C';
  if(dias<=180) return 'D';
  return 'E';
}
function cop(n){if(!n)return '$0';return '$'+Math.round(n).toLocaleString('es-CO');}
function pct(a,b){if(!b)return'0.00';return(a/b*100).toFixed(2);}
function today(){return new Date().toISOString().split('T')[0];}
function fmtDate(d){if(!d)return'‚Äî';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d;}
function parseNum(s){
  if(!s) return 0;
  s = s.toString().trim().replace(/[$\s]/g,"");
  if(!s) return 0;
  if(s.includes(",") && !s.includes(".")) s = s.replace(",",".");
  else if(s.includes(",") && s.includes(".")) s = s.replace(/\./g,"").replace(",",".");
  return parseFloat(s) || 0;
}
function parseDate(s){
  if(!s) return null;
  s = s.toString().trim();
  if(/^\d{4,5}$/.test(s)){const d=new Date(Date.UTC(1899,11,30)+parseInt(s)*864e5);return d.toISOString().split("T")[0];}
  if(/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)){const[y,m,d]=s.split("/");return y+"-"+m.padStart(2,"0")+"-"+d.padStart(2,"0");}
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){const[d,m,y]=s.split("/");return y+"-"+m.padStart(2,"0")+"-"+d.padStart(2,"0");}
  if(/^\d{1,2}-\d{1,2}-\d{4}$/.test(s)){const[d,m,y]=s.split("-");return y+"-"+m.padStart(2,"0")+"-"+d.padStart(2,"0");}
  return s;
}
function moraBadge(dias){
  if(dias===0) return `<span class="mora-badge mora-0">Al d√≠a</span>`;
  if(dias<=30) return `<span class="mora-badge mora-b">${dias}d</span>`;
  if(dias<=60) return `<span class="mora-badge mora-c">${dias}d</span>`;
  if(dias<=90) return `<span class="mora-badge mora-d">${dias}d</span>`;
  return `<span class="mora-badge mora-e">${dias}d</span>`;
}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function showToast(msg, type='ok'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`toast ${type} show`;
  setTimeout(()=>t.classList.remove('show'),3500);
}

// ==================== INIT ====================
checkSession();
</script>
</body>
</html>
